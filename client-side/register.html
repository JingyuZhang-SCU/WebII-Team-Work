<!DOCTYPE html>
<html lang="en" ng-app="charityApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration - Charity Events</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
</head>
<body ng-controller="RegisterController">
    <!-- Navigation -->
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="search.html">Search Events</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- LoadingÁä∂ÊÄÅ -->
        <div ng-show="loading" class="card">
            <div class="loading">Loading event information...</div>
        </div>
        
        <!-- ÈîôËØØÊèêÁ§∫ -->
        <div ng-show="error && !loading" class="card">
            <div class="no-results">{{error}}</div>
            <button ng-click="goBack()">Go Back</button>
        </div>
        
        <!-- Ê≥®ÂÜåË°®Âçï -->
        <div ng-show="!loading && !error && !submitted">
            <!-- Ê¥ªÂä®‰ø°ÊÅØÂç°Áâá -->
            <div class="card event-summary">
                <h2>Event Information</h2>
                <h3>{{event.name}}</h3>
                <p><strong>üìÖ Date:</strong> {{event.date | date:'fullDate'}} at {{event.date | date:'shortTime'}}</p>
                <p><strong>üìç Location:</strong> {{event.location}}</p>
                <p><strong>üè∑Ô∏è Category:</strong> {{event.category_name}}</p>
                <p><strong>üí∞ Ticket Price:</strong> ${{event.ticket_price}} per ticket</p>
            </div>
            
            <!-- Ê≥®ÂÜåË°®ÂçïÂç°Áâá -->
            <div class="card">
                <h2>Registration Form</h2>
                
                <form name="registrationForm" ng-submit="submitRegistration()" novalidate>
                    <div class="form-group">
                        <label for="full_name">Full Name *</label>
                        <input type="text" 
                               id="full_name" 
                               name="full_name"
                               ng-model="registration.full_name" 
                               required
                               placeholder="Enter your full name">
                        <div class="error-message" ng-show="registrationForm.full_name.$touched && registrationForm.full_name.$invalid">
                            Full name is required
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" 
                               id="email" 
                               name="email"
                               ng-model="registration.email" 
                               required
                               placeholder="your.email@example.com">
                        <div class="error-message" ng-show="registrationForm.email.$touched && registrationForm.email.$invalid">
                            Valid email is required
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" 
                               id="phone" 
                               name="phone"
                               ng-model="registration.phone" 
                               placeholder="04XX XXX XXX">
                    </div>
                    
                    <div class="form-group">
                        <label for="tickets_count">Number of Tickets *</label>
                        <input type="number" 
                               id="tickets_count" 
                               name="tickets_count"
                               ng-model="registration.tickets_count" 
                               min="1" 
                               max="10"
                               required
                               ng-change="calculateTotal()">
                        <div class="error-message" ng-show="registrationForm.tickets_count.$touched && registrationForm.tickets_count.$invalid">
                            Please enter a valid number (1-10)
                        </div>
                    </div>
                    
                    <!-- ÊÄªÈáëÈ¢ùÊòæÁ§∫ -->
                    <div class="total-amount">
                        <h3>Total Amount: ${{totalAmount}}</h3>
                        <p class="amount-breakdown">
                            {{registration.tickets_count || 0}} ticket(s) √ó ${{event.ticket_price}} = ${{totalAmount}}
                        </p>
                    </div>
                    
                    <!-- ÈîôËØØÊèêÁ§∫ -->
                    <div ng-show="submitError" class="error-banner">
                        {{submitError}}
                    </div>
                    
                    <!-- Êèê‰∫§ÊåâÈíÆ -->
                    <div class="form-actions">
                        <button type="submit" 
                                class="register-btn" 
                                ng-disabled="registrationForm.$invalid || submitting">
                            <span ng-show="!submitting">Complete Registration</span>
                            <span ng-show="submitting">Processing...</span>
                        </button>
                        <button type="button" 
                                class="cancel-btn" 
                                ng-click="goBack()"
                                ng-disabled="submitting">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ÊàêÂäüÁ°ÆËÆ§ -->
        <div ng-show="submitted && !error" class="card success-card">
            <div class="success-icon">‚úÖ</div>
            <h2>Registration Successful!</h2>
            <p class="success-message">
                Thank you, <strong>{{registration.full_name}}</strong>!<br>
                Your registration for <strong>{{event.name}}</strong> has been confirmed.
            </p>
            <div class="registration-summary">
                <h3>Registration Details</h3>
                <p><strong>Event:</strong> {{event.name}}</p>
                <p><strong>Date:</strong> {{event.date | date:'fullDate'}}</p>
                <p><strong>Location:</strong> {{event.location}}</p>
                <p><strong>Tickets:</strong> {{registration.tickets_count}}</p>
                <p><strong>Total Amount:</strong> ${{totalAmount}}</p>
                <p><strong>Confirmation Email:</strong> {{registration.email}}</p>
            </div>
            <div class="form-actions">
                <button class="register-btn" ng-click="goToEvent()">View Event Details</button>
                <button class="cancel-btn" ng-click="goHome()">Back to Home</button>
            </div>
        </div>
    </div>

    <script>
        var app = angular.module('charityApp', []);
        
        app.controller('RegisterController', function($scope, $http, $window) {
            $scope.event = {};
            $scope.registration = {
                full_name: '',
                email: '',
                phone: '',
                tickets_count: 1
            };
            $scope.loading = true;
            $scope.error = null;
            $scope.submitted = false;
            $scope.submitting = false;
            $scope.submitError = null;
            $scope.totalAmount = 0;
            
            // Ëé∑ÂèñÊ¥ªÂä®ID
            var urlParams = new URLSearchParams($window.location.search);
            var eventId = urlParams.get('id');
            
            if (!eventId) {
                $scope.error = 'Event ID not specified';
                $scope.loading = false;
                return;
            }
            
            // Âä†ËΩΩÊ¥ªÂä®‰ø°ÊÅØ
            $scope.loadEvent = function() {
                $http.get('http://localhost:3000/api/events/' + eventId)
                    .then(function(response) {
                        $scope.event = response.data;
                        $scope.loading = false;
                        $scope.calculateTotal();
                    })
                    .catch(function(error) {
                        console.error('Error loading event:', error);
                        $scope.error = 'Failed to load event information';
                        $scope.loading = false;
                    });
            };
            
            // ËÆ°ÁÆóÊÄªÈáëÈ¢ù
            $scope.calculateTotal = function() {
                var tickets = $scope.registration.tickets_count || 0;
                var price = $scope.event.ticket_price || 0;
                $scope.totalAmount = (tickets * price).toFixed(2);
            };
            
            // Êèê‰∫§Ê≥®ÂÜå
            $scope.submitRegistration = function() {
                if ($scope.submitting) return;
                
                $scope.submitting = true;
                $scope.submitError = null;
                
                // ÂáÜÂ§áÊï∞ÊçÆ
                var data = {
                    event_id: parseInt(eventId),
                    full_name: $scope.registration.full_name,
                    email: $scope.registration.email,
                    phone: $scope.registration.phone || null,
                    tickets_count: parseInt($scope.registration.tickets_count)
                };
                
                // ÂèëÈÄÅPOSTËØ∑Ê±Ç
                $http.post('http://localhost:3000/api/registrations', data)
                    .then(function(response) {
                        $scope.submitted = true;
                        $scope.submitting = false;
                    })
                    .catch(function(error) {
                        console.error('Error submitting registration:', error);
                        if (error.data && error.data.error) {
                            $scope.submitError = error.data.error;
                        } else {
                            $scope.submitError = 'Failed to submit registration. Please try again.';
                        }
                        $scope.submitting = false;
                    });
            };
            
            // ËøîÂõû‰∏ä‰∏ÄÈ°µ
            $scope.goBack = function() {
                $window.history.back();
            };
            
            // Ë∑≥ËΩ¨Âà∞Ê¥ªÂä®ËØ¶ÊÉÖ
            $scope.goToEvent = function() {
                $window.location.href = 'event-details.html?id=' + eventId;
            };
            
            // Ë∑≥ËΩ¨Âà∞È¶ñÈ°µ
            $scope.goHome = function() {
                $window.location.href = 'index.html';
            };
            
            // ÂàùÂßãÂåñ
            $scope.loadEvent();
        });
    </script>
    
    <style>
        .event-summary {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
        }
        
        .event-summary h2,
        .event-summary h3 {
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .total-amount {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
            text-align: center;
        }
        
        .total-amount h3 {
            color: #27ae60;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .amount-breakdown {
            color: #666;
            font-size: 0.95em;
        }
        
        .error-banner {
            background: #ffe6e6;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #e74c3c;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            flex: 1;
        }
        
        .register-btn {
            flex: 2;
        }
        
        .success-card {
            text-align: center;
        }
        
        .success-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }
        
        .success-message {
            font-size: 1.2em;
            color: #555;
            line-height: 1.8;
            margin: 20px 0;
        }
        
        .registration-summary {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            text-align: left;
        }
        
        .registration-summary h3 {
            color: #e67e22;
            margin-bottom: 15px;
        }
        
        .registration-summary p {
            margin: 10px 0;
        }
    </style>
</body>
</html>